{% extends 'base.html.twig' %}

{% block title %}{{ oeuvre.titre }} - {{ oeuvre.auteur ? oeuvre.auteur.nom : 'Auteur inconnu' }}{% endblock %}

{% block stylesheets %}
    <link rel="stylesheet" href="{{ asset('styles/oeuvre-responsive.css') }}">
    <link rel="stylesheet" href="{{ asset('styles/pages/oeuvre-detail.css') }}">

{% endblock %}

{% block body %}
<div data-user="{{ app.user ? 'true' : 'false' }}" data-oeuvre-id="{{ oeuvre.id }}">
<!-- JavaScript déplacé vers assets/scripts/pages/oeuvre-detail.js -->

<div class="main-container oeuvre-page">
    <!-- Contenu principal -->
    <main class="content">
        <!-- En-tête avec image et informations -->
        <div class="manga-header">
            <!-- Breadcrumb -->
            <div class="breadcrumb-container" style="background: rgba(139, 92, 246, 0.1); padding: 1rem; margin-bottom: 2rem; border-radius: 12px;">
                <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-secondary); flex-wrap: wrap;">
                    <a href="{{ path('app_oeuvre_list') }}" style="color: var(--accent-purple); text-decoration: none;">📚 Catalogue</a>
                    <span>→</span>
                    <span style="word-break: break-word;">{{ oeuvre.titre }}</span>
                </div>
            </div>

            <!-- Header de l'œuvre -->
            <div class="oeuvre-header" style="background: var(--card-bg); border-radius: 20px; box-shadow: var(--shadow-lg);">
                <div class="oeuvre-header-grid">
                    <!-- Couverture -->
                    <div class="oeuvre-cover">
                        {% if oeuvre.couverture %}
                            <img src="{{ smart_image_url(oeuvre.couverture) }}" alt="{{ oeuvre.titre }}" style="width: 100%; height: 100%; object-fit: cover;">
                        {% else %}
                            <div style="width: 100%; height: 100%; background: linear-gradient(45deg, var(--accent-purple), #a855f7); display: flex; align-items: center; justify-content: center; color: white; font-size: clamp(2rem, 8vw, 3rem);">
                                {% if oeuvre.type == 'Manhwa' %}🇰🇷{% else %}📖{% endif %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Détails de l'œuvre -->
                    <div class="oeuvre-details">
                        <div style="display: flex; align-items: center; gap: min(1rem, 2vw); margin-bottom: 1rem; flex-wrap: wrap; max-width: 100%;">
                            <h1 class="oeuvre-title" style="word-wrap: break-word; overflow-wrap: break-word; max-width: 100%;">{{ oeuvre.titre }}</h1>
                            {% if is_granted('ROLE_ADMIN') %}
                                <span style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; font-weight: 600; display: inline-flex; align-items: center; gap: 0.5rem; max-width: 100%;">
                                    🔐 Mode Admin
                                </span>
                            {% endif %}
                        </div>
                        
                        {% if oeuvre.auteur %}
                        <div style="display: flex; align-items: center; gap: min(2rem, 4vw); margin-bottom: 2rem; flex-wrap: wrap; max-width: 100%;">
                            <p style="font-size: clamp(1.2rem, 3vw, 1.5rem); color: var(--text-secondary); font-style: italic; margin: 0; word-wrap: break-word; max-width: 100%;">
                            par {{ oeuvre.auteur.nom }}{% if oeuvre.auteur.prenom %} {{ oeuvre.auteur.prenom }}{% endif %}
                        </p>
                            <!-- Moyenne des notes -->
                            <div id="moyenne-header" style="display: flex; align-items: center; gap: 0.5rem; background: rgba(139, 92, 246, 0.1); padding: 0.5rem 1rem; border-radius: 10px; max-width: 100%;">
                                <span style="color: var(--accent-purple); font-weight: 600;">⭐ Notre moyenne:</span>
                                <span id="average-header-display" style="color: var(--accent-purple); font-weight: 700; font-size: 1.1rem;">-</span>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Métadonnées -->
                        <div class="oeuvre-metadata">
                            <div class="metadata-badge">
                                📚 {{ oeuvre.type|default('MANGA') }}
                            </div>
                            {% if oeuvre.datePublication %}
                            <div class="metadata-badge secondary">
                                📅 {{ oeuvre.datePublication|date('Y') }}
                            </div>
                            {% endif %}
                            <div class="metadata-badge secondary">
                                📖 {{ oeuvre.chapitres|length }} chapitre{{ oeuvre.chapitres|length > 1 ? 's' : '' }}
                            </div>
                            {% if oeuvre.auteur and oeuvre.auteur.nationalite %}
                            <div class="metadata-badge secondary">
                                🌍 {{ oeuvre.auteur.nationalite }}
                            </div>
                            {% endif %}
                            
                            <!-- Badges des genres principaux -->
                            {% if oeuvre.tags|length > 0 %}
                                {% for tag in oeuvre.tags|slice(0, 3) %}
                                <a href="{{ path('app_oeuvre_list', {tag: tag.id}) }}" class="genre-tag">
                                    🎭 {{ tag.nom }}
                                </a>
                                {% endfor %}
                                {% if oeuvre.tags|length > 3 %}
                                <div style="background: rgba(225, 29, 72, 0.1); color: #e11d48; padding: 0.5rem 1rem; border-radius: 20px; font-weight: 600; border: 2px solid rgba(225, 29, 72, 0.3); font-size: 0.9rem;">
                                    +{{ oeuvre.tags|length - 3 }} autres
                                </div>
                                {% endif %}
                            {% endif %}
                        </div>
                        
                        
                        {% if oeuvre.resume %}
                        <div class="oeuvre-resume">
                            <h3>📄 Résumé</h3>
                            <p>{{ oeuvre.resume }}</p>
                        </div>
                        {% endif %}

                        <!-- Section de notation épurée -->
                        {% if app.user %}
                        <div id="rating-section-main" class="rating-section-modern">
                            <div class="rating-header">
                                <h3>Noter cette œuvre</h3>
                                <span id="current-rating-text-main" class="rating-display"></span>
                                </div>
                            
                            <div class="rating-container">
                                <div id="star-rating-main" class="star-rating-modern">
                                    <div class="star-modern star-main" data-rating="1">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                            <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/>
                                        </svg>
                            </div>
                                    <div class="star-modern star-main" data-rating="2">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                            <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/>
                                        </svg>
                                    </div>
                                    <div class="star-modern star-main" data-rating="3">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                            <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/>
                                        </svg>
                                    </div>
                                    <div class="star-modern star-main" data-rating="4">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                            <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/>
                                        </svg>
                                    </div>
                                    <div class="star-modern star-main" data-rating="5">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                            <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="rating-actions-modern">
                                <button id="submit-rating-main" class="btn-rating-modern submit" style="display: none;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <polyline points="20,6 9,17 4,12"></polyline>
                                    </svg>
                                    Confirmer
                                </button>
                                <button id="remove-rating-main" class="btn-rating-modern remove" style="display: none;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <polyline points="3,6 5,6 21,6"></polyline>
                                        <path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path>
                                    </svg>
                                    Supprimer
                                </button>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Section avec onglets -->
        <div class="tabs-section">
            <!-- Onglets -->
            <div class="tabs-header">
                <button class="tab-btn active" data-tab="chapitres">
                    📖 Chapitres ({{ oeuvre.chapitres|length }})
                </button>
                <button class="tab-btn" data-tab="commentaires">
                    💬 Commentaires ({{ commentaires|length }})
                </button>
            </div>

            <!-- Contenu onglet Chapitres -->
            <div id="tab-chapitres" class="tab-content active">
                {% if chapitres|length > 0 %}
                <div class="chapitres-grid">
                    {% for chapitre in chapitres %}
                    <div class="chapitre-card">
                        <div class="chapitre-header">
                            <div>
                                <h3 class="chapitre-title">
                                    {{ chapitre.titre }}
                                </h3>
                                <div class="chapitre-meta">
                                    <span class="chapitre-badge">
                                        Ch. {{ chapitre.ordre }}
                                    </span>
                                    <span style="color: var(--text-secondary); font-size: 0.9rem;">
                                        Ajouté le {{ chapitre.createdAt|date('d/m/Y') }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        {% if chapitre.resume %}
                        <p style="color: var(--text-secondary); line-height: 1.6; margin-bottom: 1.5rem;">
                            {{ chapitre.resume|length > 200 ? chapitre.resume|slice(0, 200) ~ '...' : chapitre.resume }}
                        </p>
                        {% endif %}
                        
                        <div class="chapitre-actions">
                            {% if chapitre.mangadxChapterId %}
                                <a href="{{ path('app_chapitre_show', {id: chapitre.id}) }}" class="btn-read">
                                    <span>📖</span> Lire le chapitre
                                </a>
                            {% else %}
                                <a href="{{ path('app_chapitre_show', {id: chapitre.id}) }}" class="btn-read">
                                    <span>📖</span> Lire le chapitre
                                </a>
                            {% endif %}
                            
                            {% if is_granted('ROLE_ADMIN') %}
                                <a href="{{ path('admin_chapitre_edit', {id: chapitre.id}) }}" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 0.6rem 1.5rem; border-radius: 20px; text-decoration: none; font-weight: 600; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
                                    <span>✏️</span> Éditer
                                </a>
                            {% endif %}
                            
                            {% if chapitre.pages|length > 0 %}
                            <span style="color: var(--text-secondary); font-size: 0.9rem;">
                                {{ chapitre.pages|length }} page(s)
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state" style="text-align: center; padding: 4rem 2rem; color: var(--text-secondary);">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">📚</div>
                    <h3 style="color: var(--text-primary); margin-bottom: 1rem;">Aucun chapitre disponible</h3>
                    <p>Cette œuvre n'a pas encore de chapitres publiés.</p>
                    <a href="{{ path('app_oeuvre_list') }}" style="background: var(--accent-purple); color: white; padding: 0.8rem 2rem; border-radius: 25px; text-decoration: none; font-weight: 600; margin-top: 1rem; display: inline-block;">
                        🔍 Explorer d'autres mangas
                    </a>
                </div>
                {% endif %}
            </div>

            <!-- Contenu onglet Commentaires -->
            <div id="tab-commentaires" class="tab-content" style="display: none;">
                {% if app.user %}

                <!-- Formulaire d'ajout de commentaire -->
                <div class="comment-form">
                    <h3 style="color: var(--text-primary); margin-bottom: 1.5rem; font-size: 1.5rem;">💬 Ajouter un commentaire</h3>
                    <form id="commentaire-form" style="display: grid; gap: 1.5rem;">
                        <div>
                            <label for="commentaire_contenu" style="display: block; margin-bottom: 0.5rem; color: var(--text-primary); font-weight: 600;">Votre commentaire</label>
                            <textarea id="commentaire_contenu" name="contenu" rows="3" placeholder="Exprimez-vous..." required></textarea>
                        </div>
                        <button type="submit" class="btn-submit">
                            💬 Publier le commentaire
                        </button>
                    </form>
                </div>
                {% else %}
                <div style="background: rgba(139, 92, 246, 0.1); border: 2px solid var(--accent-purple); border-radius: 15px; padding: 2rem; margin-bottom: 2rem; text-align: center;">
                    <h3 style="color: var(--text-primary); margin-bottom: 1rem;">🔐 Connexion requise</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Vous devez être connecté pour ajouter un commentaire.</p>
                    <a href="{{ path('app_login') }}" style="background: var(--accent-purple); color: white; padding: 0.8rem 2rem; border-radius: 10px; text-decoration: none; font-weight: 600;">
                        🔑 Se connecter
                    </a>
                </div>
                {% endif %}

                <!-- Liste des commentaires -->
                <div id="commentaires-list">
                    {% if commentaires is empty %}
                    <div class="empty-state" style="text-align: center; padding: 4rem 2rem; color: var(--text-secondary);">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">💬</div>
                        <h3 style="color: var(--text-primary); margin-bottom: 1rem;">Aucun commentaire</h3>
                        <p>Soyez le premier à donner votre avis sur cette œuvre !</p>
                    </div>
                    {% else %}
                        {% for commentaire in commentaires %}
                            {% if not commentaire.parent %}
                                <div style="background: var(--surface); border-radius: 15px; padding: 2rem; border: 1px solid var(--border-color); margin-bottom: 1.5rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                        <div style="display: flex; align-items: center; gap: 1rem;">
                                            <div style="background: var(--accent-purple); color: white; padding: 0.5rem; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: 600;">
                                                                                    {{ commentaire.auteur.email|first|upper }}
                                </div>
                                <div>
                                    <h4 style="color: var(--text-primary); margin: 0; font-size: 1.1rem;">{{ commentaire.auteur.email }}</h4>
                                                <span style="color: var(--text-secondary); font-size: 0.9rem;">{{ commentaire.createdAt|date('d/m/Y H:i') }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <p style="color: var(--text-secondary); line-height: 1.6; margin-bottom: 1.5rem;">{{ commentaire.contenu }}</p>
                                    <div style="display: flex; align-items: center; gap: 1rem;">
                                        <button class="like-btn" data-commentaire-id="{{ commentaire.id }}" style="background: none; border: 2px solid #e11d48; color: #e11d48; padding: 0.5rem 1rem; border-radius: 20px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 0.5rem;">
                                            <span class="like-icon">{{ app.user ? (commentaire.isLikedByUser(app.user) ? '❤️' : '🤍') : '🤍' }}</span>
                                            <span class="like-count">{{ commentaire.likes|length }}</span> J'aime
                                        </button>
                                        {% if app.user %}
                                        <button class="reply-btn" data-commentaire-id="{{ commentaire.id }}" style="background: none; border: 2px solid var(--accent-purple); color: var(--accent-purple); padding: 0.5rem 1rem; border-radius: 20px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 0.5rem;">
                                            💬 Répondre
                                        </button>
                                        {% endif %}
                                    </div>

                                    <!-- Formulaire de réponse (caché par défaut) -->
                                    <div id="reply-form-{{ commentaire.id }}" style="display: none; margin-top: 1rem; padding: 1rem; background: rgba(139, 92, 246, 0.05); border-radius: 10px;">
                                        <textarea id="reply-content-{{ commentaire.id }}" placeholder="Écrivez votre réponse..." style="width: 100%; padding: 0.8rem; border: 2px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary); resize: vertical; font-family: inherit; min-height: 80px; box-sizing: border-box;"></textarea>
                                        <div style="margin-top: 0.8rem; display: flex; gap: 0.8rem;">
                                            <button onclick="submitReply({{ commentaire.id }})" style="background: var(--accent-purple); color: white; padding: 0.6rem 1.2rem; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                                                Publier
                                            </button>
                                            <button onclick="cancelReply({{ commentaire.id }})" style="background: var(--border-color); color: var(--text-primary); padding: 0.6rem 1.2rem; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                                                Annuler
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Réponses -->
                                    {% if commentaire.reponses|length > 0 %}
                                    <div style="margin-top: 1rem;">
                                        <button 
                                            class="toggle-replies-btn" 
                                            data-commentaire-id="{{ commentaire.id }}" 
                                            style="background: none; border: none; color: var(--accent-purple); font-weight: 600; cursor: pointer; padding: 0.5rem 0; display: flex; align-items: center; gap: 0.5rem; font-size: 0.95rem; transition: all 0.3s ease;"
                                            onmouseover="this.style.textDecoration='underline'"
                                            onmouseout="this.style.textDecoration='none'"
                                        >
                                            <span class="toggle-icon">▼</span>
                                            <span class="toggle-text">Voir {{ commentaire.reponses|length }} réponse{{ commentaire.reponses|length > 1 ? 's' : '' }}</span>
                                        </button>
                                        <div id="replies-{{ commentaire.id }}" style="display: none;">
                                            {% for reponse in commentaire.reponses %}
                                                <div class="reponse-item" style="background: rgba(139, 92, 246, 0.05); border-radius: 15px; padding: 2rem; border: 1px solid var(--border-color); margin: 1rem 0 1rem {{ 30 }}px; border-left: 3px solid var(--accent-purple);">
                                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                                        <div style="display: flex; align-items: center; gap: 1rem;">
                                                            <div style="background: var(--accent-purple); color: white; padding: 0.5rem; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: 600;">
                                                                                                                    {{ reponse.auteur.email|first|upper }}
                                                </div>
                                                <div>
                                                    <h4 style="color: var(--text-primary); margin: 0; font-size: 1rem;">{{ reponse.auteur.email }}</h4>
                                                                <span style="color: var(--text-secondary); font-size: 0.9rem;">{{ reponse.createdAt|date('d/m/Y H:i') }}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <p style="color: var(--text-secondary); line-height: 1.6; margin-bottom: 1rem; font-size: 1rem;">{{ reponse.contenu }}</p>
                                                    <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                                                        <button class="like-btn" data-commentaire-id="{{ reponse.id }}" style="background: none; border: 2px solid #e11d48; color: #e11d48; padding: 0.5rem 1rem; border-radius: 20px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 0.5rem;">
                                                            <span class="like-icon">{{ app.user ? (reponse.isLikedByUser(app.user) ? '❤️' : '🤍') : '🤍' }}</span>
                                                            <span class="like-count">{{ reponse.likes|length }}</span> J'aime
                                                        </button>
                                                        {% if app.user %}
                                                        <button class="reply-to-reply-btn" data-commentaire-id="{{ reponse.id }}" style="background: none; border: 2px solid var(--accent-purple); color: var(--accent-purple); padding: 0.5rem 1rem; border-radius: 20px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 0.5rem;">
                                                            💬 Répondre
                                                        </button>
                                                        {% endif %}
                                                    </div>

                                                    <!-- Formulaire de réponse à une réponse -->
                                                    <div id="reply-to-reply-form-{{ reponse.id }}" style="display: none; margin-top: 1rem; padding: 1rem; background: rgba(139, 92, 246, 0.05); border-radius: 10px; border-left: 3px solid var(--accent-purple);">
                                                        <textarea id="reply-to-reply-content-{{ reponse.id }}" placeholder="Répondre à cette réponse..." style="width: 100%; padding: 0.8rem; border: 2px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary); resize: vertical; font-family: inherit; min-height: 80px; box-sizing: border-box;"></textarea>
                                                        <div style="margin-top: 0.8rem; display: flex; gap: 0.8rem;">
                                                            <button onclick="submitReplyToReply({{ reponse.id }})" style="background: var(--accent-purple); color: white; padding: 0.6rem 1.2rem; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                                                                Publier
                                                            </button>
                                                            <button onclick="cancelReplyToReply({{ reponse.id }})" style="background: var(--border-color); color: var(--text-primary); padding: 0.6rem 1.2rem; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                                                                Annuler
                                                            </button>
                                                        </div>
                                                    </div>

                                                    <!-- Réponses aux réponses (niveau 2) -->
                                                    {% if reponse.reponses|length > 0 %}
                                                    <div style="margin-top: 1rem;">
                                                        <button 
                                                            class="toggle-replies-to-replies-btn" 
                                                            data-commentaire-id="{{ reponse.id }}" 
                                                            style="background: none; border: none; color: var(--accent-purple); font-weight: 600; cursor: pointer; padding: 0.5rem 0; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; transition: all 0.3s ease;"
                                                            onmouseover="this.style.textDecoration='underline'"
                                                            onmouseout="this.style.textDecoration='none'"
                                                        >
                                                            <span class="toggle-icon">▼</span>
                                                            <span class="toggle-text">Voir {{ reponse.reponses|length }} réponse{{ reponse.reponses|length > 1 ? 's' : '' }} à cette réponse</span>
                                                        </button>
                                                        <div id="replies-to-replies-{{ reponse.id }}" style="display: none;">
                                                            {% for reponseToReponse in reponse.reponses %}
                                                                <div style="background: rgba(139, 92, 246, 0.03); border-radius: 12px; padding: 1.5rem; border: 1px solid var(--border-color); margin: 0.8rem 0 0.8rem {{ 20 }}px; border-left: 3px solid #fbbf24;">
                                                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.8rem;">
                                                                        <div style="display: flex; align-items: center; gap: 0.8rem;">
                                                                            <div style="background: #fbbf24; color: white; padding: 0.4rem; border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.9rem;">
                                                                                {{ reponseToReponse.auteur.email|first|upper }}
                                                                            </div>
                                                                            <div>
                                                                                <h5 style="color: var(--text-primary); margin: 0; font-size: 0.9rem;">{{ reponseToReponse.auteur.email }}</h5>
                                                                                <span style="color: var(--text-secondary); font-size: 0.8rem;">{{ reponseToReponse.createdAt|date('d/m/Y H:i') }}</span>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    <p style="color: var(--text-secondary); line-height: 1.5; margin-bottom: 0.8rem; font-size: 0.9rem;">{{ reponseToReponse.contenu }}</p>
                                                                    <div style="display: flex; align-items: center; gap: 0.8rem;">
                                                                        <button class="like-btn" data-commentaire-id="{{ reponseToReponse.id }}" style="background: none; border: 2px solid #e11d48; color: #e11d48; padding: 0.4rem 0.8rem; border-radius: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 0.4rem; font-size: 0.85rem;">
                                                                            <span class="like-icon">{{ app.user ? (reponseToReponse.isLikedByUser(app.user) ? '❤️' : '🤍') : '🤍' }}</span>
                                                                            <span class="like-count">{{ reponseToReponse.likes|length }}</span> J'aime
                                                                        </button>
                                                    </div>
                                                                </div>
                                                            {% endfor %}
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Bouton retour -->
        <div style="margin-top: 3rem; text-align: center;">
            <a href="{{ path('app_oeuvre_list') }}" style="background: rgba(139, 92, 246, 0.1); color: var(--accent-purple); padding: 1rem 2rem; border-radius: 25px; text-decoration: none; font-weight: 600; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 0.5rem; border: 2px solid var(--accent-purple);">
                ← Retour au catalogue
            </a>
        </div>
    </main>

    <!-- Sidebar -->
    <aside class="sidebar">
        <!-- Informations condensées -->
        <div class="sidebar-section">
            <h3 class="sidebar-title">📖 Informations</h3>
            <div class="sidebar-details">
                <div class="sidebar-detail-item">
                    <span>Type</span>
                    <span>{{ oeuvre.type|default('MANGA') }}</span>
                </div>
                <div class="sidebar-detail-item">
                    <span>Chapitres</span>
                    <span>{{ oeuvre.chapitres|length }}</span>
                </div>
                {% if oeuvre.datePublication %}
                <div class="sidebar-detail-item">
                    <span>Année</span>
                    <span>{{ oeuvre.datePublication|date('Y') }}</span>
                </div>
                {% endif %}
                {% if oeuvre.auteur %}
                <div class="sidebar-detail-item">
                    <span>Auteur</span>
                    <span>{{ oeuvre.auteur.nom }}</span>
                </div>
                {% endif %}
                {% if oeuvre.tags|length > 0 %}
                <div class="sidebar-detail-item">
                    <span>Genres</span>
                    <span>{{ oeuvre.tags|length }} genre(s)</span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Actions principales -->
        <div class="sidebar-section">
            <h3 class="sidebar-title">⚡ Actions</h3>
            <div class="sidebar-actions">
                {% if chapitres|length > 0 %}
                {% set firstChapter = chapitres|first %}
                {% if firstChapter.mangadxChapterId %}
                    <a href="{{ path('app_chapitre_show', {id: firstChapter.id}) }}" class="sidebar-btn sidebar-btn-primary">
                        📖 Lire
                    </a>
                {% else %}
                    <a href="{{ path('app_chapitre_show', {id: firstChapter.id}) }}" class="sidebar-btn sidebar-btn-primary">
                        📖 Lire
                    </a>
                {% endif %}
                {% endif %}
                
                <!-- Bouton favori -->
                {% if is_granted('ROLE_USER') %}
                <button 
                    id="favorite-btn-{{ oeuvre.id }}"
                    class="sidebar-btn sidebar-btn-favorite{% if isFavorite %} favorited{% endif %}"
                    onclick="toggleFavorite({{ oeuvre.id }}, this)"
                    data-oeuvre-id="{{ oeuvre.id }}"
                    title="{{ isFavorite ? 'Retirer des favoris' : 'Ajouter aux favoris' }}"
                >
                    <span id="favorite-icon-{{ oeuvre.id }}">{{ isFavorite ? '❤️' : '🤍' }}</span>
                    <span id="favorite-text-{{ oeuvre.id }}">{{ isFavorite ? 'Retirer des favoris' : 'Ajouter aux favoris' }}</span>
                </button>
                {% endif %}
                
                <a href="{{ path('app_oeuvre_list') }}" class="sidebar-btn sidebar-btn-secondary">
                    📚 Catalogue
                </a>
            </div>
        </div>

        <!-- Administration (si admin) -->
        {% if is_granted('ROLE_ADMIN') %}
        <div class="sidebar-section">
            <h3 class="sidebar-title">🔐 Admin</h3>
            <div class="sidebar-actions">
                <a href="{{ path('admin_oeuvre_edit', {id: oeuvre.id}) }}" class="sidebar-btn sidebar-btn-warning">
                    ✏️ Éditer
                </a>
                <a href="{{ path('admin_oeuvre_chapitres', {id: oeuvre.id}) }}" class="sidebar-btn sidebar-btn-info">
                    📖 Chapitres
                </a>
                <a href="{{ path('admin_chapitre_new', {id: oeuvre.id}) }}" class="sidebar-btn sidebar-btn-success">
                    ➕ Nouveau
                </a>
            </div>
        </div>
        {% endif %}
    </aside>
</div>

<!-- Styles CSS déplacés vers assets/styles/pages/oeuvre-detail.css -->

<!-- Scripts de la page -->
<script src="{{ asset('scripts/pages/oeuvre-detail.js') }}"></script>
</div>
{% endblock %} 
