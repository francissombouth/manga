{% extends 'base.html.twig' %}

{% block title %}MangaTh√®que - Mangas populaires{% endblock %}

{% block stylesheets %}
<link rel="stylesheet" href="{{ asset('assets/css/vortex-theme.css') }}">
{% endblock %}

{% block body %}
{% include 'partials/_navigation.html.twig' %}

<section class="hero">
    <div class="container">
        <h1>D√©couvrez les meilleurs mangas</h1>
        <p>Powered by MangaDx - Une collection de milliers de mangas √† lire gratuitement</p>
        
        <form action="{{ path('mangadx_search') }}" method="GET" class="search-form">
            <input type="text" name="q" class="search-input" placeholder="Rechercher un manga..." required>
            <button type="submit" class="search-btn">üîç Rechercher</button>
        </form>
    </div>
</section>

<section class="stats">
    <div class="container">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">{{ totalMangas }}+</div>
                <div class="stat-label">Mangas disponibles</div>
                <div style="color: #00d4ff; font-size: 0.8rem; margin-top: 0.5rem;">‚ú® Collection massive !</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ currentPage }}</div>
                <div class="stat-label">Page actuelle</div>
                <div style="color: #ff6b6b; font-size: 0.8rem; margin-top: 0.5rem;">sur {{ totalPages }} pages</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">üìö</div>
                <div class="stat-label">Lecture gratuite</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">üåç</div>
                <div class="stat-label">Multi-langues</div>
            </div>
        </div>
        
        <h2 class="section-title">üî• Mangas Populaires</h2>
        
        <div class="alert-info">
            <small>
                ‚úÖ <strong>Contenu familial</strong> : Seuls les mangas tout public et √† contenu suggestif l√©ger sont affich√©s.
                <br>Le contenu √©rotique et pornographique est automatiquement exclu.
            </small>
        </div>
        
        <div class="alert-warning">
            <small>
                üîÑ <strong>Donn√©es en temps r√©el</strong> : {{ totalMangas }}+ mangas disponibles avec pagination
                <br>üìÖ Page {{ currentPage }}/{{ totalPages }} charg√©e le {{ "now"|date("d/m/Y √† H:i") }} ‚Ä¢ 
                üåê API officielle : <code style="color: #00d4ff;">api.mangadx.org</code>
            </small>
        </div>
        
        <div class="mangas-grid">
            {% for manga in mangas %}
                <a href="{{ path('mangadx_manga_show', {id: manga.id}) }}" class="manga-card">
                    {% if manga.cover_url %}
                        <!-- DEBUG: Cover URL = {{ manga.cover_url }} -->
                        <img src="{{ path('image_proxy') }}?url={{ manga.cover_url|url_encode }}" 
                             alt="{{ manga.title }}" 
                             class="manga-cover" 
                             loading="lazy" 
                             onerror="this.src='{{ path('image_proxy') }}'; console.log('Image error for: {{ manga.title }}');">
                    {% else %}
                        <!-- DEBUG: No cover URL for {{ manga.title }} -->
                        <img src="{{ path('image_proxy') }}" 
                             alt="{{ manga.title }}" 
                             class="manga-cover">
                    {% endif %}
                    
                    <!-- Overlay VortexScans style -->
                    <div class="manga-overlay">
                        <div class="manga-title-overlay">{{ manga.title }}</div>
                        {% if manga.authors %}
                            <div class="manga-author-overlay">par {{ manga.authors|join(', ') }}</div>
                        {% endif %}
                        
                        {% if manga.year %}
                            <div class="manga-rating">
                                <span>üìÖ</span>
                                <span>{{ manga.year }}</span>
                            </div>
                        {% endif %}
                        
                        <span class="manga-meta-badge">{{ manga.status|title }}</span>
                        
                        {% if manga.tags %}
                            <div class="manga-genres">
                                {% for tag in manga.tags|slice(0, 3) %}
                                    <span class="genre-tag">{{ tag }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                        
                        <div class="manga-overlay-cta">
                            <span class="cta-text">üìñ Voir les d√©tails</span>
                        </div>
                    </div>
                </a>
            {% else %}
                <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: #6c757d;">
                    <h3>Aucun manga trouv√©</h3>
                    <p>Impossible de charger les mangas depuis MangaDx pour le moment.</p>
                </div>
            {% endfor %}
        </div>
        
        {# Syst√®me de pagination #}
        {% if totalPages > 1 %}
        <div class="pagination-container">
            <nav class="pagination" aria-label="Navigation des pages">
                {# Bouton Pr√©c√©dent #}
                {% if hasPrevPage %}
                    <a href="{{ path('mangadx_home', {page: currentPage - 1}) }}" class="pagination-btn pagination-prev">
                        ‚Üê Pr√©c√©dent
                    </a>
                {% else %}
                    <span class="pagination-btn pagination-prev disabled">
                        ‚Üê Pr√©c√©dent
                    </span>
                {% endif %}

                {# Num√©ros de pages #}
                <div class="pagination-numbers">
                    {# Premi√®re page #}
                    {% if currentPage > 3 %}
                        <a href="{{ path('mangadx_home', {page: 1}) }}" class="pagination-number">1</a>
                        {% if currentPage > 4 %}
                            <span class="pagination-dots">...</span>
                        {% endif %}
                    {% endif %}

                    {# Pages autour de la page actuelle #}
                    {% for page in range(max(1, currentPage - 2), min(totalPages, currentPage + 2)) %}
                        {% if page == currentPage %}
                            <span class="pagination-number active">{{ page }}</span>
                        {% else %}
                            <a href="{{ path('mangadx_home', {page: page}) }}" class="pagination-number">{{ page }}</a>
                        {% endif %}
                    {% endfor %}

                    {# Derni√®re page #}
                    {% if currentPage < totalPages - 2 %}
                        {% if currentPage < totalPages - 3 %}
                            <span class="pagination-dots">...</span>
                        {% endif %}
                        <a href="{{ path('mangadx_home', {page: totalPages}) }}" class="pagination-number">{{ totalPages }}</a>
                    {% endif %}
                </div>

                {# Bouton Suivant #}
                {% if hasNextPage %}
                    <a href="{{ path('mangadx_home', {page: currentPage + 1}) }}" class="pagination-btn pagination-next">
                        Suivant ‚Üí
                    </a>
                {% else %}
                    <span class="pagination-btn pagination-next disabled">
                        Suivant ‚Üí
                    </span>
                {% endif %}
            </nav>
            
            <div class="pagination-info">
                Page {{ currentPage }} sur {{ totalPages }} ‚Ä¢ 
                Affichage de {{ mangasPerPage }} mangas par page
            </div>
        </div>
        {% endif %}
    </div>
</section>

<footer class="credit">
    <div class="container">
        <p>
            Donn√©es fournies par <a href="https://mangadex.org" target="_blank">MangaDx</a> ‚Ä¢ 
            Merci aux √©quipes de traduction ‚Ä¢ 
            Application respectant la <a href="https://api.mangadx.org/docs/" target="_blank">politique d'usage MangaDx</a>
        </p>
    </div>
</footer>
{% endblock %} 